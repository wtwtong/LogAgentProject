#  日志收集项目

## 项目框架

![img](E:\Go_Code\src\LogAgentDemo\note\assets\img\]MILVO1KC31YKB3C57]X$VI.png)



![image-20240203181259098-1707051256436-1707054529851](E:\Go_Code\src\LogAgentDemo\note\assets\img\image-20240203181259098-1707051256436-1707054529851.png)



## 组件介绍

LogAgent:日志收集客户端，用来收集服务器上的日志。

kafka：高吞吐量的分布式队列（Linkin 开发，apache顶级开源项目）

ElasticSearch：开源的搜索引擎，提供基于HTTP RESTful的web接口。

Kibaba:开源的ES数据分析和可视化工具。

## 将学到的技能

- 服务端agent开发
- 后端服务组件开发
- kafka和zookeeper的使用
- etcd的使用
- ES和Kibana的使用
- grafana和influxdb的使用




**组件默认端口**

zookeeper : 2181 

kafka : 9092

etcd : 2379

ES : 9200

Kibana : 5601

influxdb : 8086

grafana : 3000

## kafka与zookeeper

Kafka是一种高性能、分布式的消息队列

而ZooKeeper则是一种高可用的、分布式的应用程序协调服务

在Kafka中，ZooKeeper扮演着非常重要的角色]

## Windows中使用各组件

- 启动kafka中的zookeeper

```shell
bin\windows\zookeeper-server-start.bat config\zookeeper.properties
```

- 启动kafka

```shell
bin\windows\kafka-server-start.bat config\server.properties
```

- 启动kafka消费者终端命令

```shell
bin\windows\kafka-console-consumer.bat --bootstrap-server 127.0.0.1:9092 --topic web --from-beginning
```

- 启动etcd

````shell
etcd.exe
````

- 启动ES

````shell
elasticsearch.bat
````

- 启动Kibana

  在浏览器输入地址**http://127.0.0.1:5601/**

````
kibana.bat
````

- 启动influxdb 

````
influxd.exe
````

- 启动grafana

  在浏览器输入地址 **http://127.0.0.1:3000/**

````shell
grafana.server.exe
````

**sarama操作kafka**

Windows系统指定1.19版本

```go
require github.com/Shopify/sarama v1.19.0
```

使用sarama往kafka发送消息

```go
func main() {
	//配置
	config := sarama.NewConfig()
	config.Producer.RequiredAcks = sarama.WaitForAll          //ACK
	config.Producer.Partitioner = sarama.NewRandomPartitioner //分区
	config.Producer.Return.Successes = true                   //确认
	//连接kafka
	client, err := sarama.NewSyncProducer([]string{"127.0.0.1:9092"}, config)
	if err != nil {
		fmt.Println("Producer closed err:", err)
		return
	}
	defer client.Close()
	//封装消息
	msg := &sarama.ProducerMessage{}
	msg.Topic = "web"
	msg.Value = sarama.StringEncoder("2024.1.19 wang tong!")
	//	发送消息
	paten, offset, err := client.SendMessage(msg)
	if err != nil {
		fmt.Println("send message err:", err)
		return
	}
	fmt.Printf("paten:%v  offset:%v\n", paten, offset)

}
```

**tail读取文件**

```shell
require github.com/nxadm/tail v1.4.11
```

使用tail读取文件

```shell
// tail包读取日志文件
func main() {
	filename := `E:/Go_Code/kafka_logs/web-0/00000000000000000000.log`
	//配置
	config := tail.Config{
		ReOpen:    true,
		Follow:    true,
		Location:  &tail.SeekInfo{Offset: 0, Whence: 2},
		MustExist: false,
		Poll:      true,
	}
	//打开文件开始读取数据
	tails, err := tail.TailFile(filename, config)
	if err != nil {
		fmt.Printf("tail %s failed,err:%v\n", tails, err)
		return
	}
	//	开始读取数据
	var (
		msg *tail.Line
		ok  bool
	)
	for {
		msg, ok = <-tails.Lines //chan tail.line
		if !ok {
			fmt.Printf("tail file close reopen,filename:%s\n", tails.Filename)
			time.Sleep(time.Second) //读取出错等1秒
			continue
		}
		fmt.Println("msg:", msg.Text)
	}
}
```

## etcd

etcd 是什么？

```
是一种开源的分布式统一键值存储，用于分布式系统或计算机集群的共享配置、服务发现和的调度协调。etcd 有助于促进更加安全的自动更新，协调向主机调度的工作，并帮助设置容器的覆盖网络。

etcd 是许多其他项目的核心组件。最值得注意的是，它是 Kubernetes 的首要数据存储。应用从 etcd 读取数据并写入到其中；通过分散配置数据，为节点配置提供冗余和弹性。
```

它在本项目中的作用

​        项目中有集群，用etcd来管理配置文件，方便更改配置，

put和get操作

```go
package main

import (
	"fmt"
	"go.etcd.io/etcd/client/v3"
	"golang.org/x/net/context"
	"time"
)

func main() {
	cli, err := clientv3.New(clientv3.Config{
		Endpoints:   []string{"127.0.0.1:2379"},
		DialTimeout: time.Second * 5,
	})
	if err != nil {
		fmt.Println("client.New err:", err)
		return
	}
	defer cli.Close()
	//	put
	ctx, cancle := context.WithTimeout(context.Background(), time.Second)
	_, err = cli.Put(ctx, "大王", "特别好看")
	if err != nil {
		fmt.Println("put filed err:", err)
		return
	}
	cancle()
	//	get
	ctx, cancle = context.WithTimeout(context.Background(), time.Second)
	rp, err := cli.Get(ctx, "大王")
	if err != nil {
		fmt.Println("get filed err:", err)
		return
	}

	for _, ev := range rp.Kvs {
		fmt.Printf("key:%s,value:%s\n", ev.Key, ev.Value)
	}
	cancle()
}

```



## etcd watch

etcd watch 查看etcd操作

```go
func main() {
	cli, err := clientv3.New(clientv3.Config{
		Endpoints:   []string{"127.0.0.1:2379"},
		DialTimeout: time.Second * 5,
	})
	if err != nil {
		fmt.Println("client New err:", err)
		return
	}
	watchCh := cli.Watch(context.Background(), "大王")
	for wtch := range watchCh {
		for _, vn := range wtch.Events {
			fmt.Printf("Type:%s,key:%s,value:%s\n", vn.Type, vn.Kv.Key, vn.Kv.Value)
		}
	}
}

```



### gopsutil包

是`psutil`的Go语言版本，可以监控系统信息

具体操作

````go
package main

import (
	"fmt"
	"github.com/shirou/gopsutil/cpu"
	"github.com/shirou/gopsutil/disk"
	"github.com/shirou/gopsutil/load"
	"github.com/shirou/gopsutil/net"
	"time"
)

// cpu info
func getCpuInfo() {
	cpuInfos, err := cpu.Info()
	if err != nil {
		fmt.Printf("get cpu info failed, err:%v", err)
	}
	for _, ci := range cpuInfos {
		fmt.Println(ci)
	}
	// CPU使用率
	for {
		percent, _ := cpu.Percent(time.Second, false)
		fmt.Printf("cpu percent:%v\n", percent)
	}
}

// CPU 负载
func getCpuLoad() {
	info, _ := load.Avg()
	fmt.Printf("%v\n", info)
}

// 磁盘 信息
// disk info
func getDiskInfo() {
	parts, err := disk.Partitions(true)
	if err != nil {
		fmt.Printf("get Partitions failed, err:%v\n", err)
		return
	}
	for _, part := range parts {
		fmt.Printf("part:%v\n", part.String())
		diskInfo, _ := disk.Usage(part.Mountpoint)
		fmt.Println(diskInfo)
	}

	ioStat, _ := disk.IOCounters()
	for k, v := range ioStat {
		fmt.Printf("%v:%v\n", k, v)
	}
}

// 网络 信息
func getNetInfo() {
	info, _ := net.IOCounters(true)
	for index, v := range info {
		fmt.Printf("%v:%v send:%v recv:%v\n", index, v, v.BytesSent, v.BytesRecv)
	}
}

func main() {
	//getCpuInfo()
	//getCpuLoad()
	//getDiskInfo()
	getNetInfo()
}

````

### influxDB

时序数据库

类似OpenTSDB

操作：

````go
package main

import (
	"fmt"
	"log"
	"time"

	client "github.com/influxdata/influxdb1-client/v2"
)

// influxdb demo

func connInflux() client.Client {
	cli, err := client.NewHTTPClient(client.HTTPConfig{
		Addr:     "http://127.0.0.1:8086",
		Username: "admin",
		Password: "",
	})
	if err != nil {
		log.Fatal(err)
	}
	return cli
}

// query
func queryDB(cli client.Client, cmd string) (res []client.Result, err error) {
	q := client.Query{
		Command:  cmd,
		Database: "test",
	}
	if response, err := cli.Query(q); err == nil {
		if response.Error() != nil {
			return res, response.Error()
		}
		res = response.Results
	} else {
		return res, err
	}
	return res, nil
}

// insert
func writesPoints(cli client.Client) {
	bp, err := client.NewBatchPoints(client.BatchPointsConfig{
		Database:  "test",
		Precision: "s", //精度，默认ns
	})
	if err != nil {
		log.Fatal(err)
	}
	tags := map[string]string{"cpu": "ih-cpu"}
	fields := map[string]interface{}{
		"idle":   201.1,
		"system": 43.3,
		"user":   86.6,
	}

	pt, err := client.NewPoint("cpu_usage", tags, fields, time.Now())
	if err != nil {
		log.Fatal(err)
	}
	bp.AddPoint(pt)
	err = cli.Write(bp)
	if err != nil {
		log.Fatal(err)
	}
	log.Println("insert success")
}

func main() {
	conn := connInflux()
	fmt.Println(conn)

	// insert
	writesPoints(conn)

	// 获取10条数据并展示
	qs := fmt.Sprintf("SELECT * FROM %s LIMIT %d", "cpu_usage", 10)
	res, err := queryDB(conn, qs)
	if err != nil {
		log.Fatal(err)
	}

	for _, row := range res[0].Series[0].Values {
		for j, value := range row {
			log.Printf("j:%d value:%v\n", j, value)
		}
	}
}

````

项目功能函数解读



![image-20240124003140267-1707053569488](E:\Go_Code\src\LogAgentDemo\note\assets\img\image-20240124003140267-1707053569488.png)



